#!/bin/bash
eval_banner() {
echo -e "\n\e[36mLINOOP TEK INNOVATIONS RHCSA EVALUATION 2024 TOOL STARTING\nKEEP CALM AND SIT TIGHT\e[0m"
echo -e "\n\e[37m***********************RUNNING NOW******************************\n\e[0m"
}
: ' This Script evaluate students tasks
    - check static IP   	        --DONE
    - check repos			        --DONE
    - check root pw			        --DONE
    - check chrony			        --DONE
    - validate_autofs				--DONE
    - check selinux                 --DONE
    - check collaboration directory --DONE
  '
if [ `id -u` != 0 ];then
        echo ""
        echo -e "\e[31mFailed: Please Run this Script as root\e[0m\n"
        exit 1
fi
###############################################################################
check_interface() {
    if ip link show "$1" > /dev/null 2>&1; then
       echo -e "\nNetwork interface $1 exists.\n"
       #echo -e "          Running Validation"
       #echo -e "------------------------------------------\n"
       return 0
    else
       echo -e "\e[31mNetwork interface $1 does not exist. Please try again.\e[0m\n"
       return 1
    fi
}
################################################################################
check_IP() {
    echo "Check Q1 Checking Root PW........"
   while true; do
      read -p "Please Enter your network card name (e.g., enp0s3, ens): " n_card
      check_interface "$n_card" && break
   done

   ip_test=$(nmcli con show "$n_card" | grep ipv4.method | awk '{print $2}')

   echo -n "Checking IP"
   for i in {1..10}; do
       echo -n "."
       sleep 0.1
   done
   echo ""

   if [ -z "$ip_test" ]; then
       echo -e "\e[31mCould not determine IP method for interface $n_card\e[0m\n"
       return 1
   fi

   if [ "$ip_test" == "manual" ]; then
        echo -e "\e[32mIP_Check: PASS\e[0m\n"
   else
        echo -e "\e[31mIP_Check: FAIL\e[0m\n"
   fi
}
################################################################################
check_repos(){
   echo "Q2: Checking Repositories.........."
app_chk=$(yum repolist enabled | grep -i AppStream | wc -l)
base_chk=$(yum repolist enabled | grep -i BaseOs | wc -l)

   if [ "$app_chk" -eq 0 ];then
     echo -e "\e[31mAPPSTREAM_Check: Fail\e[0m\n"
   else
     echo -e "\e[32mAPPSTREAM_Check: Pass\e[0m\n"
   fi
   if [ "$base_chk" -eq 0 ];then
     echo -e "\e[31mBASEOS_Check: Fail\e[0m\n"
   else
     echo -e "\e[32mBASEOS_Check: Pass\e[0m\n"
   fi
}

###############################################################################
check_pw() {
   echo "Check Q3 Checking Root PW........"

   # Install sshpass if not already installed
   if ! command -v sshpass &>/dev/null; then
      dnf install -q -y sshpass &>/dev/null
      if [ $? -ne 0 ]; then
         echo -e "\e[31mFailed to install sshpass. Exiting.\e[0m"
         exit 1
      fi
   fi

   # Update sshd config
   sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
   sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

   systemctl restart sshd &>/dev/null
   if [ $? -ne 0 ]; then
      echo -e "\e[31mFailed to restart sshd. Exiting.\e[0m"
      exit 1
   fi

   # Try logging in with root password
   sshpass -p 'redhat' ssh -o StrictHostKeyChecking=no root@localhost 'pwd >/dev/null' &>/dev/null
   if [ $? -eq 0 ]; then
      echo -e "\e[32mRoot_PW_Check: Pass\e[0m\n"
   else
      echo -e "\e[31mRoot_PW_Check: Fail\e[0m\n"
   fi
}
###################################################################################
check_chrony() {
    echo "Q4: Checking Chrony service..."
    
    # Service active?
    if systemctl is-active --quiet chronyd; then
        echo -e "\e[32mChrony service: Active\e[0m"
    else
        echo -e "\e[31mChrony service: Inactive\e[0m"
        return 1
    fi

    # Leap status check â€“ correct field
    leap_status=$(chronyc tracking | awk -F': ' '/Leap status/ {print $2}')
    
    if [ "$leap_status" = "Normal" ]; then
        echo -e "\e[32mChrony sync: OK : Pass\e[0m"
    else
        echo -e "\e[31mChrony sync: Not synchronized : Fail\e[0m"
    fi
}
######################################################################################
user_name="user1"
validate_autofs() {
    echo "Q5: Checking Autofs......."

    # cleanup any previous test file
    rm -f /rhome/$user_name/uniq1 &>/dev/null

    # access the path to trigger autofs mount
    su - $user_name -c "touch /rhome/$user_name/uniq1" &>/dev/null
    file_st=$?

    # now check if autofs mounted it
    mount | grep "/rhome/$user_name" &>/dev/null
    mn_st=$?

    if [ $file_st -eq 0 ] && [ $mn_st -eq 0 ]; then
        echo -e "\e[32mAutoFS_Check: Pass\e[0m\n"
    else
        echo -e "\e[31mAutoFS_Check: Fail\e[0m\n"
    fi
}
######################################################################################
check_selinux() {
    echo "Q6: Validating Webserver selinux file context, firewall rule & selinux Port 82..."

    # Check website content
    webpage_content=$(curl -s --max-time 3 http://localhost:82)
    curl_status=$?

    # Check firewall for port 82
    firewall-cmd --list-ports 2>/dev/null | grep -q '^82/tcp'
    fw_status=$?

    # Check if SELinux allows port 82 for HTTP
    semanage port -l 2>/dev/null | grep -E '^http_port_t' | grep -q '\b82\b'
    selinux_port_status=$?

    
    if [ $curl_status -eq 0 ] && [ "$webpage_content" = "I am enjoying RHCSA preparation" ]; then
        echo -e "\e[32mSelinux_Web_Running: Pass\e[0m"
    else
        echo -e "\e[31mSelinux_Web_Running: Fail\e[0m"
    fi

      if [ $fw_status -eq 0 ]; then
        echo -e "\e[32mSelinux_Web_Firewall_Port: Pass\e[0m"
    else
        echo -e "\e[31mSelinux_Web_Firewall_Port: Fail\e[0m"
    fi

    if [ $selinux_port_status -eq 0 ]; then
        echo -e "\e[32mSelinux_HTTP_Port_Label: Pass\e[0m"
    else
        echo -e "\e[31mSelinux_HTTP_Port_Label: Fail\e[0m"
    fi

    echo
}
################################################################################
check_collaboration_dir() {

    echo "Q7: Validating Collaboration Directory /project ..."
    echo

    dir="/project"
    group="developers"

    r1=r2=r3=r4=r5="FAIL"

    # Step 1: Directory exists
    if [ -d "$dir" ]; then
        echo -e "\e[32m[1] Directory exists: PASS\e[0m"
        r1="PASS"
    else
        echo -e "\e[31m[1] Directory exists: FAIL\e[0m"
        echo -e "\n\e[31mCollaboration Directory: FAIL\e[0m"
        return
    fi

    # Step 2: Group ownership
    dir_group=$(stat -c "%G" "$dir")
    if [ "$dir_group" = "$group" ]; then
        echo -e "\e[32m[2] Group = developers: PASS\e[0m"
        r2="PASS"
    else
        echo -e "\e[31m[2] Group ownership: FAIL (Found $dir_group)\e[0m"
    fi

    # Step 3: Permissions (770, 2770, 3770 allowed)
    perm=$(stat -c "%a" "$dir")
    if [[ "$perm" =~ ^(770|2770|3770)$ ]]; then
        echo -e "\e[32m[3] Permissions correct (770 family): PASS\e[0m"
        r3="PASS"
    else
        echo -e "\e[31m[3] Permissions incorrect: FAIL (Found $perm)\e[0m"
    fi

    # Step 4: SGID bit
    stat -c "%A" "$dir" | grep -q "s" &&
        echo -e "\e[32m[4] SGID bit: PASS\e[0m" && r4="PASS" ||
        echo -e "\e[31m[4] SGID bit: FAIL\e[0m"

    # Step 5: Sticky bit
    stat -c "%A" "$dir" | grep -q "T" &&
        echo -e "\e[32m[5] Sticky bit: PASS\e[0m" && r5="PASS" ||
        echo -e "\e[31m[5] Sticky bit: FAIL\e[0m"

    # Final Status
    echo
    if [[ "$r1$r2$r3$r4$r5" == "PASSPASSPASSPASSPASS" ]]; then
        echo -e "\e[32mCollaboration Directory: PASS\e[0m"
    else
        echo -e "\e[31mCollaboration Directory: FAIL\e[0m"
    fi

    echo
}
################################################################################
